# Strace

## Utiliser Strace

[Strace](https://strace.io) vous permet de voir les appels système effectués par un processus et ce que ces appels système renvoient.

### Trace de construction <a href="#build-strace" id="build-strace"></a>

Pour créer strace, exécutez la commande suivante :

```
mmma -j6 external/strace
```

### Attachement à un processus en cours d'exécution <a href="#attach-strace" id="attach-strace"></a>

Le cas d'utilisation le plus simple et le plus courant de strace consiste à l'attacher à un processus en cours d'exécution, ce que vous pouvez faire avec :

```
adb shell strace -f -p PID
```

L'indicateur `-f` indique à strace de s'attacher à tous les threads du processus, ainsi qu'à tous les nouveaux threads générés ultérieurement.

Un processus typique fait beaucoup d'appels système, vous voudrez donc consulter la [page de manuel strace](http://man7.org/linux/man-pages/man1/strace.1.html) pour savoir comment collecter uniquement les données qui vous intéressent réellement.

### Utilisation sur une application <a href="#app-strace" id="app-strace"></a>

Pour utiliser strace sur une application :

1. Configurez l'appareil de manière à pouvoir exécuter strace. Vous devez être root, désactiver SELinux et redémarrer le runtime pour supprimer le filtre seccomp qui empêchera sinon strace de s'exécuter :

* ```
  adb root
  adb shell setenforce 0
  adb shell stop
  adb shell start
  ```
* Configurez un répertoire accessible en écriture pour les journaux strace, car strace s'exécutera sous l'uid de l'application :
* ```
  adb shell mkdir -m 777 /data/local/tmp/strace
  ```
* Choisissez le processus à tracer et lancez-le :

1. ```
   adb shell setprop wrap.com.android.calendar '"logwrapper strace -f -o /data/local/tmp/strace/strace.com.android.calendar.txt"'
   ```
2. Lancez le processus normalement.

### Utilisation sur le zygote <a href="#zygote-systrace" id="zygote-systrace"></a>

Pour utiliser strace sur le zygote, corrigez la ligne zygote `init.rc` pertinente (nécessite `adb shell setenforce 0` ):

```
cd system/core/
patch -p1 <<EOF
--- a/rootdir/init.zygote32.rc
+++ b/rootdir/init.zygote32.rc
@@ -1,4 +1,4 @@
-service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
+service zygote /system/bin/strace -o /data/local/tmp/zygote.strace /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
     class main
     socket zygote stream 660 root system
     onrestart write /sys/android_power/request_state wake
EOF
```

### Obtention des journaux strace lors du démarrage d'Android <a href="#get-logs-boot" id="get-logs-boot"></a>

Pour obtenir les journaux de suivi lors du démarrage d'Android, apportez les modifications suivantes :

* Étant donné que le nom du processus passe de `zygote` à `strace` , le service donné peut ne pas démarrer en raison du `file_context` SELinux manquant pour `strace` . La solution consiste à ajouter une nouvelle ligne pour strace dans `system/sepolicy/private/file_contexts` et à copier le contexte de fichier d'origine. Exemple :
* ```
  /dev/socket/zygote      u:object_r:zygote_socket:s0
  + /system/bin/strace u:object_r:zygote_socket:s0
  ```
* Ajoutez le paramètre kernel ou bootconfig, puis démarrez le périphérique en mode permissif SELinux. Vous pouvez le faire en ajoutant `androidboot.selinux=permissive` à `BOARD_KERNEL_CMDLINE` ou à `BOARD_BOOTCONFIG` dans Android 12 avec la version du noyau 5.10 ou supérieure. (Cette variable devient en lecture seule dans `build/core/Makefile` mais est toujours disponible sous `/device/*/BoardConfig` .)\
  \
  Exemple pour le périphérique Pixel (sailfish) dans `/device/google/marlin/sailfish/BoardConfig.mk` :

```
- BOARD_KERNEL_CMDLINE := ....  androidboot.hardware=sailfish ...
+BOARD_KERNEL_CMDLINE := ....  androidboot.hardware=sailfish ...  androidboot.selinux=permissive
```

Après avoir effectué la modification, créez et flashez l'image de démarrage et le périphérique démarrera en mode permissif.
