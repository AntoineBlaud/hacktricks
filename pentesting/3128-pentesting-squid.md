# 3128 - Pentesting Squid

## Basic Information

**Squid** is a caching and forwarding HTTP web proxy. It has a wide variety of uses, including speeding up a web server by caching repeated requests, caching web, DNS and other computer network lookups for a group of people sharing network resources, and aiding security by filtering traffic. Although primarily used for HTTP and FTP, Squid includes limited support for several other protocols including Internet Gopher, SSL, TLS and HTTPS. Squid does not support the SOCKS protocol, unlike Privoxy, with which Squid can be used in order to provide SOCKS support. (From [here](https://en.wikipedia.org/wiki/Squid\_\(software\))).

**Default port:** 3128

```
PORT     STATE  SERVICE      VERSION
3128/tcp open   http-proxy   Squid http proxy 4.11
```

## Enumeration

### Web Proxy

You can try to set this discovered service as proxy in your browser. However, if it's configured with HTTP authentication you will be prompted for usernames and password.

```bash
# Try yo proxify curl
curl --proxy http://10.10.11.131:3128 http://10.10.11.131
```

### Nmap proxified

You can also try to abuse the proxy to **scan internal ports proxifying nmap**.\
Configure proxychains to use the squid proxy adding he following line at the end of the proxichains.conf file: `http 10.10.10.10 3128`

Then run nmap with proxychains to **scan the host from local**: `proxychains nmap -sT -n -p- localhost`

### Squid Proxy

Browsing to port 3128 reveals a domain name and an email address.

```
ports=$(nmap -p- --min-rate=1000 -T4 10.10.10.224 | grep ^[0-9] | cut -d '/' -f 1 | tr
'\n' ',' | sed s/,$//)
nmap -sC -sV -p$ports 10 .10.10.
```

### DNS

Knowing the domain name realcorp.htb, we can start enumerating the DNS server using the dnsenum `` tool.

This found few new subdomains. wpad.realcorp.htb subomain looks interesting.

### WPAD

```
dnsenum --dnsserver 10 .10.10.224 -f
/usr/share/wordlists/SecLists/Discovery/DNS/namelist.txt realcorp.htb
```

The Web Proxy Auto-Discovery (WPAD) Protocol can be used to allow web browsers to automatically\
discover the location of Proxy Auto-Configuration (PAC) files on the network, either via DHCP or via DNS. A\
PAC file is a text file that instructs a browser to forward traffic to a proxy server, instead of directly to the\
destination server.

The DNS-based method requires a host called wpad. serving a PAC file called wpad.dat via HTTP

(http://wpad./wpad.dat). Browsers running on computers in the domain will automatically get\
this file and use it for auto-configuration.

In our case it should be located at [http://wpad.realcorp.htb/wpad.dat.](http://wpad.realcorp.htb/wpad.dat.) Since we can't access the\
internal network directly, we can try making a request using Squid as the proxy.

This action is failing as the proxy server requires authentication. We can try to send a request to localhost\
through squid proxy.

It returns an Invalid URL message, meaning that accessing localhost indeed doesn't require any

authentication. Depending on the Squid configuration, requests with source address of 127.0.0.1 might\
be allowed to bypass authentication for specific destinations, or even for all destinations in some cases (the\
configuration directive http\_access allow localhost is often found in squid.conf by default).

We update proxychains configuration /etc/proxychains.conf in our machine to use dynamic\
chaining.Dynamic chaining will help us to run our traffic through every proxy on the list.

We also add wpad.realcorp.htb entry to our hosts file.

```
curl --proxy http://10.10.10.224:3128 http://wpad.realcorp.htb/wpad.dat
```

```
http 10 .10.10.224 3128
http 127 .0.0.1 3128
```

Now we try again to access wpad.realcorp.htb host through the use of proxychains.

This action is also failing. Less restrictive ACLs might be in place for requests with source address of\
10.197.243.77, which is the proxy address. We update proxychains configuration to add the new proxy

address 10.197.243.77.

Sending request to wpad.realcorp.htb host once again with the above configuration succeeds.

It is now possible to download the PAC file from this host.

```
echo '10.197.243.31 wpad.realcorp.htb' >> /etc/hosts
```

```
http 10.10.10.224 3128
http 127.0.0.1 3128
http 10.197.243.77 3128
```

From the PAC file, we observe that the domain realcorp.htb, along with the subnet ranges\
10.197.243.0/24 and 10.241.251.0/24, are configured for direct access, while every other destination is

set to pass through the proxy server.
